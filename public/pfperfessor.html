<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน้าโพสต์</title>
    <link rel="stylesheet" href="/public/style/pfstd_pfs.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <!-- แถบด้านบน -->
    <header class="header">
        <div class="logo">
            <a href="/public/webprofessor.html">
                <img src="/public/assets/logo.jpg" alt="logo" class="profile-picture">
            </a>
        </div>
        <div class="account-icon">
            <a href="/public/pfprofessor.html">
                <i class="fas fa-user-circle"></i>
            </a>
        </div>
    </header>

    <!-- Section to display user information -->
    <main class="main-content">
        <div class="student-name">
            <h2>ข้อมูลผู้ใช้</h2>
            <p><strong>ชื่อ-นามสกุล:</strong> <span id="displayProfName"></span></p>
        </div>
        <div class="info-container">
            <div class="user-info">
                <p><strong>Email:</strong> <span id="displayProfEmail"></span></p>
                <p><strong>เบอร์โทรศัพท์:</strong> <span id="displayProfPhone"></span></p>
                <p><strong>คณะ:</strong> <span id="displayProfFaculty"></span></p>
            </div>

            <!-- แสดงโพสต์ของอาจารย์ทั้งหมด -->
            <div id="post-container"></div>
        </div>
    </main>

    <!-- ฟอร์มสำหรับการแก้ไขโพสต์ (ซ่อนไว้ก่อน) -->
    <div id="edit-post-form" style="display:none;">
        <h3>แก้ไขโพสต์</h3>
        <form id="edit-post-form-content">
            <input type="hidden" id="edit-post-id" />
            <label for="edit-job-title">ตำแหน่งงาน:</label>
            <input type="text" id="edit-job-title" required />
            <label for="edit-job-description">รายละเอียด:</label>
            <textarea id="edit-job-description" required></textarea>
            <!-- เพิ่มฟิลด์อื่นๆ ตามที่ต้องการ -->
            <button type="submit">บันทึกการเปลี่ยนแปลง</button>
            <button type="button" onclick="closeEditForm()">ยกเลิก</button>
        </form>
    </div>

    <script>
        // แสดงข้อมูลผู้ใช้จาก localStorage
        document.getElementById('displayProfName').textContent = localStorage.getItem('ProfName') || 'N/A';
        document.getElementById('displayProfEmail').textContent = localStorage.getItem('ProfEmail') || 'N/A';
        document.getElementById('displayProfPhone').textContent = localStorage.getItem('ProfPhone') || 'N/A';
        document.getElementById('displayProfFaculty').textContent = localStorage.getItem('Prof_Faculty') || 'N/A';

        // ฟังก์ชันดึงโพสต์ทั้งหมดของอาจารย์จาก API
        async function fetchProfessorPosts() {
            try {
                const response = await fetch('http://localhost:3005/api/postProf');
                const posts = await response.json();
                const postContainer = document.getElementById('post-container');
                postContainer.innerHTML = ''; // เคลียร์ container ก่อนแสดงโพสต์ใหม่

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.classList.add('post-box');
                    postElement.innerHTML = `
                        <div class="post-header">
                            <h3>${post.Job_title}</h3>
                            <div class="post-actions">
                                <button onclick="editPost('${post._id}')" class="edit-btn"><i class="fas fa-edit"></i></button>
                                <button onclick="deletePost('${post._id}')" class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <p><strong>รายละเอียด:</strong> ${post.Job_description}</p>
                        <p><strong>สถานที่:</strong> ${post.Job_location}</p>
                        <p><strong>อาคาร:</strong> ${post.Job_building}</p>
                        <p><strong>ห้อง:</strong> ${post.Job_room}</p>
                        <p><strong>เวลาที่เริ่ม:</strong> ${post.Job_time_start}</p>
                        <p><strong>เวลาที่สิ้นสุด:</strong> ${post.Job_time_end}</p>
                        <p><strong>จำนวนที่รับ:</strong> ${post.Count}</p>
                        <p><strong>จำนวนสำรอง:</strong> ${post.Reserve_count}</p>
                        <p><strong>การเดินทาง:</strong> ${post.Traveling_type}</p>
                        <p><strong>อาหาร:</strong> ${post.Food_Sup}</p>
                        <p><strong>ค่าตอบแทน:</strong> ${post.Salary}</p>
                    `;
                    postContainer.appendChild(postElement);
                });
            } catch (error) {
                console.error('Error fetching posts:', error);
                alert('ไม่สามารถดึงโพสต์ได้');
            }
        }

        // ฟังก์ชันแก้ไขโพสต์
        async function editPost(postId) {
            // โหลดข้อมูลโพสต์ที่ต้องการแก้ไข
            try {
                const response = await fetch(`http://localhost:3005/api/postProf/${postId}`);
                const post = await response.json();

                // แสดงฟอร์มแก้ไขและกรอกข้อมูลโพสต์ที่โหลด
                document.getElementById('edit-post-id').value = post._id;
                document.getElementById('edit-job-title').value = post.Job_title;
                document.getElementById('edit-job-description').value = post.Job_description;
                document.getElementById('edit-job-location').value = post.Job_location;
                document.getElementById('edit-job-building').value = post.Job_building;
                document.getElementById('edit-job-room').value = post.Job_room;
                document.getElementById('edit-job-time-start').value = post.Job_time_start;
                document.getElementById('edit-job-time-end').value = post.Job_time_end;
                document.getElementById('edit-job-Count').value = post.Count;
                document.getElementById('edit-job-Reserve-count').value = post.Reserve_count;
                document.getElementById('edit-job-Traveling-type').value = post.Traveling_type;
                document.getElementById('edit-job-Food-Sup').value = post.Food_Sup;
                document.getElementById('edit-job-Salary').value = post.Salary;

                // กรอกข้อมูลฟิลด์อื่นๆ ที่ต้องการ

                document.getElementById('edit-post-form').style.display = 'block';
            } catch (error) {
                console.error('Error fetching post:', error);
                alert('ไม่สามารถดึงข้อมูลโพสต์ได้');
            }
        }

        document.getElementById('edit-post-form-content').addEventListener('submit', async (event) => {
            event.preventDefault(); // ป้องกันการรีเฟรชหน้า

            const postId = document.getElementById('edit-post-id').value;
            const updatedPost = {
                Job_title: document.getElementById('edit-job-title').value,
                Job_description: document.getElementById('edit-job-description').value,
                Job_location: document.getElementById('edit-job-location').value,
                Job_building: document.getElementById('edit-job-building').value,
                Job_room: document.getElementById('edit-job-room').value,
                Job_time_start: document.getElementById('edit-job-time-start').value,
                Job_time_end: document.getElementById('edit-job-time-end').value,
                Count: document.getElementById('edit-job-Count').value,
                Reserve_count: document.getElementById('edit-job-Reserve-count').value,
                Traveling_type: document.getElementById('edit-job-Traveling-type').value,
                Food_Sup: document.getElementById('edit-job-Food-Sup').value,
                Salary: document.getElementById('edit-job-Salary').value
            };

            try {
                const response = await fetch(`http://localhost:3005/api/postProf/update/${postId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedPost)
                });

                const result = await response.json();
                alert('โพสต์ได้รับการแก้ไขแล้ว');
                fetchProfessorPosts(); // รีเฟรชโพสต์ทั้งหมด
                closeEditForm(); // ปิดฟอร์มแก้ไข
            } catch (error) {
                console.error('Error updating post:', error);
                alert('ไม่สามารถแก้ไขโพสต์ได้');
            }
        });
        function closeEditForm() {
            document.getElementById('edit-post-form').style.display = 'none';
        }

        // ฟังก์ชันลบโพสต์
        async function deletePost(postId) {
            if (confirm('คุณแน่ใจว่าต้องการลบโพสต์นี้?')) {
                try {
                    await fetch(`http://localhost:3005/api/postProf/delete/${postId}`, {
                        method: 'DELETE'
                    });

                    alert('โพสต์ถูกลบเรียบร้อยแล้ว');
                    fetchProfessorPosts(); // รีเฟรชโพสต์ทั้งหมด
                } catch (error) {
                    console.error('Error deleting post:', error);
                    alert('ไม่สามารถลบโพสต์ได้');
                }
            }
        }

        // โหลดโพสต์ของอาจารย์เมื่อหน้าเว็บโหลดเสร็จ
        document.addEventListener('DOMContentLoaded', fetchProfessorPosts);
    </script>
</body>

</html>